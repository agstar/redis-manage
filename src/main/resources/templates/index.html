<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>redis-manager</title>
    <link rel="stylesheet" href="../static/plugins/element-ui/index.2.4.11.css"
          th:href="@{plugins/element-ui/index.2.4.11.css}">
    <script th:src="@{plugins/vue/vue.2.5.21.js}" src="../static/plugins/vue/vue.2.5.21.js"></script>
    <script th:src="@{plugins/element-ui/index.2.4.11.js}" src="../static/plugins/element-ui/index.2.4.11.js"></script>
    <script src="../static/plugins/axios/axios.min.js" th:src="@{plugins/axios/axios.min.js}"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        .el-header {
            background-color: #B3C0D1;
            color: #333;
            line-height: 60px;
        }

        .el-aside {
            color: #333;
        }

        html, body, #app {
            height: 100%;
        }
    </style>
</head>
<body>
<div id="app">
    <el-container style="height: 100%; border: 1px solid #eee">
        <el-aside width="200px" style="background-color: rgb(238, 241, 246)">
            <el-menu @open="handleOpen" @select="handleSelect">
                <el-submenu :index="serverIndex+''" v-for="(server,serverIndex) in serverList" :key="serverIndex">
                    <template slot="title"><i class="el-icon-message"></i>{{server.name}}</template>
                    <template v-for="(keyCount,dbIndex) in server.dbList">
                        <el-menu-item :index="server.name+'-'+dbIndex+'-'+keyCount" :key="dbIndex">
                            {{'db'+dbIndex+' ('+keyCount+')'}}
                        </el-menu-item>
                    </template>
                </el-submenu>
            </el-menu>
        </el-aside>
        <el-container style="height: 100%;">
            <el-header style="text-align: right; font-size: 12px">
                <el-button type="primary" @click="dialogFormVisible = true">添加redis</el-button>
                <el-button type="primary">删除redis</el-button>
                <el-button type="primary">修改redis</el-button>
            </el-header>
            <el-main style="height: 100%;">
                <el-row :gutter="20" style="height: 100%;">
                    <el-col :span="4" style="height: 100%;overflow: auto">
                        <el-tree :data="keys" :props="defaultProps" check-on-click-node
                                 @node-click="handleNodeClick"></el-tree>
                    </el-col>
                    <el-col :span="20" style="height: 100%;overflow: auto">
                        <el-form>
                            <el-row :gutter="10">
                                <el-col :span="12">
                                    <el-form-item :label="keyType.toUpperCase()+':'">
                                        <el-col :span="18">
                                            <el-input v-model="keyName"></el-input>
                                        </el-col>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="2">
                                    <el-form-item label="TTL:">
                                        <span>-1</span>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="2">
                                    <el-form-item>
                                        <el-button>Rename</el-button>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="2">
                                    <el-form-item>
                                        <el-button>Delete</el-button>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="3">
                                    <el-form-item>
                                        <el-button>Reload Value</el-button>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="2">
                                    <el-form-item>
                                        <el-button>Set TTL</el-button>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-form>
                        <el-row>
                            <el-col :span="12">
                                Value:
                            </el-col>
                            <el-col :span="12">
                                View as:
                                <template>
                                    <el-select v-model="viewType">
                                        <el-option
                                                v-for="item in viewTypeItem"
                                                :key="item"
                                                :label="item"
                                                :value="item">
                                        </el-option>
                                    </el-select>
                                </template>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-input rows="15" type="textarea" v-model="value"></el-input>
                        </el-row>
                        <el-row style="margin-top: 20px;">
                            <el-button type="primary" style="position: relative;right:0;">Save</el-button>
                        </el-row>
                        <!-- <el-row style="height: 30%;">
                             <el-input rows="8" type="textarea" v-model="value"></el-input>
                         </el-row>-->
                    </el-col>
                </el-row>
            </el-main>
        </el-container>
    </el-container>
    <el-dialog title="添加redis" :visible.sync="dialogFormVisible">
        <el-form :model="server">
            <el-form-item label="连接名称" :label-width="formLabelWidth">
                <el-input v-model="server.name" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="host" :label-width="formLabelWidth">
                <el-input v-model="server.host" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="端口" :label-width="formLabelWidth">
                <el-input v-model="server.port" type="number" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="密码" :label-width="formLabelWidth">
                <el-input v-model="server.auth" autocomplete="off"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="success" @click="testConnection()">测试连接</el-button>
            <el-button type="primary" @click="addServer()">确 定</el-button>
            <el-button @click="dialogFormVisible = false">取 消</el-button>
        </div>
    </el-dialog>
</div>
</body>
<script>
    const vm = new Vue({
        el: "#app",
        data: {
            head: 'headersss',
            main: 'main',
            aside: 'Aside',
            keyName: 'redisKey',
            value: 'asdfffffffffffffffffjkalsjdklfjaskldjfkljasdkljfklasjdklfjklsjdkfljklsadjfkljsdfjas' +
                'djfkjsdkfjlskajdflsjdlfjlskdjflkajsdfkljslkdjflksjdflkjsdlkjflkasdjflkjasdkfjlkasdjflkjasdlkf',
            viewType: 'JSON',
            viewTypeItem: ['JSON', 'TEXT'],
            keyType: 'string',
            dialogFormVisible: false,
            server: {
                name: '',
                host: '',
                port: 6379,
                auth: ''
            },
            formLabelWidth: '120px',
            serverKeys: [],
            serverList: [],
            result: {dataType: null, key: null, value: null},
            keys: [{
                label: '一级 1',
                index: '1-1',
                children: [{
                    label: '二级 1-1',
                    index: '1-2',
                    children: [{
                        label: '三级 1-1-1',
                        index: '1-3',
                    }]
                }]
            }],
            defaultProps: {
                children: 'children',
                label: 'label'
            },

        },
        created() {
            console.log('created')
        },
        mounted() {
            // console.log('mounted')
            this.getServer();
        },
        methods: {
            addServer() {
                axios.post('/server', this.server)
                    .then((response) => {
                        this.$message({
                            message: response.data.message,
                            type: response.data.flag ? 'success' : 'error'
                        });
                        //console.log(response);
                        if (response.data.flag) {
                            this.serverList.push(this.server)
                        }
                    })
                    .catch((error) => {
                        console.log(error);
                    });
                this.dialogFormVisible = false;
                // this.clearServer();
            },
            clearServer() {
                this.server = {
                    name: '',
                    host: '',
                    port: 6379,
                    auth: ''
                }
            },
            testConnection() {
                axios.post('/testConnection', this.server)
                    .then((response) => {
                        this.$message({
                            message: response.data.message,
                            type: response.data.flag ? 'success' : 'error'
                        });
                    })
                    .catch((error) => {
                        console.log(error);
                        this.$message({
                            message: error,
                            type: 'error'
                        });
                    });
            },
            getServer() {
                axios.get('/server', this.server)
                    .then((response) => {
                        // this.serverList = response.data.data;
                        this.serverList = response.data.data;
                        console.log('----------getServer-------------');
                        console.log(response.data.data);
                        this.serverList.forEach((item) => {
                            this.$set(item, 'dbList', []);
                            this.$set(item, 'firstOpen', true);
                        });
                        this.$message({
                            message: response.data.message,
                            type: response.data.flag ? 'success' : 'error'
                        });
                        console.log(response);
                    })
                    .catch((error) => {
                        console.log(error);
                    });
                this.dialogFormVisible = false;
                // this.clearServer();
            },
            getKeyList(servername, dbIndex) {
                axios.get(`/key/${servername}/${dbIndex}`)
                    .then((res) => {
                        if (res.data.flag) {
                            this.keys = res.data.data;
                        }
                        console.log(res);
                    })
                    .catch((error) => {
                        console.log(error);
                    });
            },
            getKey(servername, dbIndex, keyName) {
                axios.get(`/key/${servername}/${dbIndex}/${keyName}`)
                    .then((res) => {
                        if (res.data.flag) {
                            this.result.dataType = res.data.data.dataType;
                            this.result.value = res.data.data.value;
                            console.log(this.result.value);
                        }
                        console.log(res);
                    })
                    .catch((error) => {
                        console.log(error);
                    });
            },
            getKeyCount(server) {
                axios.get('/keyCount/' + server.name)
                    .then((res) => {
                        if (res.data.flag) {
                            server['dbList'] = res.data.data;
                            server['firstOpen'] = false;
                        }
                        this.$message({
                            message: res.data.message,
                            type: res.data.flag ? 'success' : 'error'
                        });
                        console.log(res);
                    })
                    .catch((error) => {
                        console.log(error);
                    });
                this.dialogFormVisible = false;
            },

            handleOpen(index, indexPath) {
                console.log('open--->' + index + '<--->' + indexPath);
                if (index.indexOf('-') > -1) {
                    //open---10.216.115.188-1---1,10.216.115.188-1
                    //this.getKey()
                } else {
                    let server = this.serverList[parseInt(index)];
                    console.log(JSON.stringify(server));
                    let firstOpen = server['firstOpen'];
                    if (firstOpen) {
                        this.getKeyCount(server)
                    }
                }

            },
            handleSelect(index, indexPath) {
                let indexs = index.split('-');
                console.log('index--' + indexs.length + '<---->' + indexs);
                if (indexs.length === 3) {
                    let keyCount = indexs[2];
                    let dbindex = indexs[1];
                    let serverName = indexs[0];
                    console.log('select-->' + index + '---' + indexPath);
                    console.log('select dbindex-->' + dbindex + '<--->' + serverName);
                    this.getKeyList(serverName, dbindex);
                }
            },
            handleNodeClick(data) {
                console.log(data);
                var index = data.index;
                var serverName = index.substr(0, index.lastIndexOf(":"));
                var dbIndex = index.substr(index.lastIndexOf(":") + 1);
                var key = data.label;
                this.getKey(serverName, dbIndex, key);
            }
        }
    })
</script>
</html>