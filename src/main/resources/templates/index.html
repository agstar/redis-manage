<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>redis-manage</title>
    <link rel="stylesheet" href="../static/plugins/element-ui/index.2.4.11.css"
          th:href="@{plugins/element-ui/index.2.4.11.css}">
    <style>
        .el-header {
            background-color: #B3C0D1;
            color: #333;
            line-height: 60px;
        }

        .el-aside {
            color: #333;
        }
    </style>
</head>
<body>
<div id="app">
    <el-container style="height: 950px; border: 1px solid #eee">
        <el-aside width="200px" style="background-color: rgb(238, 241, 246)">
            <el-menu @open="handleOpen" @select="handleSelect">
                <el-submenu :index="serverIndex+''" v-for="(server,serverIndex) in serverList" :key="serverIndex">
                    <template slot="title"><i class="el-icon-message"></i>{{server.name}}</template>
                    <template v-for="(keyCount,dbIndex) in server.dbList">
                        <el-menu-item v-if="keyCount==0" :index="index+'-'+server.name+'-'+dbIndex" :key="dbIndex">
                            {{'db'+dbIndex+' ('+keyCount+')'}}
                        </el-menu-item>
                        <el-submenu v-if="keyCount>0" :index="index+'-'+server.name+'-'+itemIndex" :key="dbIndex">
                            <template slot="title">{{'db'+dbIndex+' ('+keyCount+')'}}</template>
                            <el-menu-item :index="index+'-'+server.name+'-'+dbIndex+'-'+key" v-for="key in keys"
                                          :key="key">{{key}}
                            </el-menu-item>
                        </el-submenu>
                    </template>
                </el-submenu>
            </el-menu>
        </el-aside>
        <el-container>
            <el-header style="text-align: right; font-size: 12px">
                <el-button type="primary" @click="dialogFormVisible = true">添加redis</el-button>
                <el-button type="primary">删除redis</el-button>
                <el-button type="primary">修改redis</el-button>
            </el-header>
            <el-main>
                <el-form>
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item :label="keyType.toUpperCase()+':'">
                                <el-col :span="18">
                                    <el-input v-model="keyName"></el-input>
                                </el-col>
                            </el-form-item>
                        </el-col>
                        <el-col :span="2">
                            <el-form-item label="TTL:">
                                <span>-1</span>
                            </el-form-item>
                        </el-col>
                        <el-col :span="2">
                            <el-form-item>
                                <el-button>Rename</el-button>
                            </el-form-item>
                        </el-col>
                        <el-col :span="2">
                            <el-form-item>
                                <el-button>Delete</el-button>
                            </el-form-item>
                        </el-col>
                        <el-col :span="3">
                            <el-form-item>
                                <el-button>Reload Value</el-button>
                            </el-form-item>
                        </el-col>
                        <el-col :span="2">
                            <el-form-item>
                                <el-button>Set TTL</el-button>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
                <el-row>
                    <el-col :span="12">
                        Value:
                    </el-col>
                    <el-col :span="12">
                        View as:
                        <template>
                            <el-select v-model="viewType">
                                <el-option
                                        v-for="item in viewTypeItem"
                                        :key="item"
                                        :label="item"
                                        :value="item">
                                </el-option>
                            </el-select>
                        </template>
                    </el-col>
                </el-row>
                <el-row>
                    <el-input type="textarea" v-model="value" rows="15"></el-input>
                </el-row>
                <el-row>
                    <el-button style="float:right;">Save</el-button>
                </el-row>
                <el-row style="margin:10px;">
                    <el-input type="textarea" v-model="value" rows="15"></el-input>
                </el-row>
            </el-main>
        </el-container>
    </el-container>
    <el-dialog title="添加redis" :visible.sync="dialogFormVisible">
        <el-form :model="server">
            <el-form-item label="连接名称" :label-width="formLabelWidth">
                <el-input v-model="server.name" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="host" :label-width="formLabelWidth">
                <el-input v-model="server.host" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="端口" :label-width="formLabelWidth">
                <el-input v-model="server.port" type="number" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="密码" :label-width="formLabelWidth">
                <el-input v-model="server.auth" autocomplete="off"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="success">测试连接</el-button>
            <el-button type="primary" @click="addServer">确 定</el-button>
            <el-button @click="dialogFormVisible = false">取 消</el-button>
        </div>
    </el-dialog>
</div>
</body>
<script th:src="@{plugins/vue/vue.2.5.21.js}" src="../static/plugins/vue/vue.2.5.21.js"></script>
<script th:src="@{plugins/element-ui/index.2.4.11.js}" src="../static/plugins/element-ui/index.2.4.11.js"></script>
<script src="../static/plugins/axios/axios.min.js" th:src="@{plugins/axios/axios.min.js}"></script>
<script>
    const vm = new Vue({
        el: "#app",
        data: {
            head: 'headersss',
            main: 'main',
            aside: 'Aside',
            keyName: 'redisKey',
            value: 'asdfffffffffffffffffjkalsjdklfjaskldjfkljasdkljfklasjdklfjklsjdkfljklsadjfkljsdfjas' +
            'djfkjsdkfjlskajdflsjdlfjlskdjflkajsdfkljslkdjflksjdflkjsdlkjflkasdjflkjasdkfjlkasdjflkjasdlkf',
            viewType: 'JSON',
            viewTypeItem: ['JSON', 'TEXT'],
            keyType: 'string',
            dialogFormVisible: false,
            server: {
                name: '',
                host: '',
                port: 6379,
                auth: ''
            },
            formLabelWidth: '120px',
            serverKeys: [],
            serverList: []
        },
        created() {
            console.log('created')
        },
        mounted() {
            console.log('mounted')
            this.getServer();
        },
        methods: {
            addServer() {
                let $this = this;
                axios.post('/server', this.server)
                    .then(function (response) {
                        $this.$message({
                            message: response.data.message,
                            type: response.data.flag ? 'success' : 'error'
                        });
                        console.log(response);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                $this.dialogFormVisible = false;
                // this.clearServer();
            },
            clearServer() {
                this.server = {
                    name: '',
                    host: '',
                    port: 6379,
                    auth: ''
                }
            },
            getServer() {
                let $this = this;
                axios.get('/server', this.server)
                    .then(function (response) {
                        // $this.serverList = response.data.data;
                        $this.serverList = response.data.data;
                        console.log('----------getServer-------------');
                        console.log(response.data.data);
                        $this.serverList.forEach(function (item) {
                            $this.$set(item, 'dbList', []);
                            $this.$set(item, 'firstOpen', true);
                        });
                        $this.$message({
                            message: response.data.message,
                            type: response.data.flag ? 'success' : 'error'
                        });
                        console.log(response);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                $this.dialogFormVisible = false;
                // this.clearServer();
            },
            /*getKey(server) {
                var $this = this;
                axios.get('/key', this.server)
                    .then(function (res) {
                        if (res.data.flag) {
                            $this.serverKeys = res.data.data;
                            $this.$set($this.serverKeys, 'serverKeys', true);
                        }
                        $this.$message({
                            message: res.data.message,
                            type: res.data.flag ? 'success' : 'error'
                        });
                        console.log(res);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                $this.dialogFormVisible = false;
            },*/
            getKey(servername, dbIndex) {
                let $this = this;
                axios.get(`/key/${servername}/${dbIndex}`, this.server)
                    .then(function (res) {
                        if (res.data.flag) {
                            $this.serverKeys = res.data.data;

                        }

                        console.log(res);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
            getKeyCount(server) {
                let $this = this;
                axios.get('/keyCount/' + server.name)
                    .then(function (res) {
                        if (res.data.flag) {
                            server['dbList'] = res.data.data;
                            server['dbList'].forEach(function (item) {
                                $this.$set(item, 'keys', []);
                            });
                            server['firstOpen'] = false;
                        }
                        $this.$message({
                            message: res.data.message,
                            type: res.data.flag ? 'success' : 'error'
                        });
                        console.log(res);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                $this.dialogFormVisible = false;
            },
            handleOpen(index, indexPath) {
                console.log('open---' + index + '---' + indexPath);
                if (index.indexOf('-') > -1) {
                    //open---10.216.115.188-1---1,10.216.115.188-1

                    this.getKey()
                } else {
                    let server = this.serverList[index];
                    console.log(JSON.stringify(server));
                    let firstOpen = server['firstOpen'];
                    if (firstOpen) {
                        this.getKeyCount(server)
                    }
                }

            },
            handleSelect(index, indexPath) {
                let dbindex = index.substring(index.lastIndexOf('-'));
                let serverName = index.substring(0, index.lastIndexOf('-'));
                console.log('select-->' + index + '---' + indexPath);
                console.log('select dbindex-->' + dbindex + '<--->' + serverName)
            }
        }
    })
</script>
</html>